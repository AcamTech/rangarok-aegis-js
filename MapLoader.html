<!doctype html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1, user-scalable=no" />
		
		<script src="common.js"></script>
		<script src="prototype.js"></script>
		
		<script src="settings.js"></script>
		
		<script src="Tables/mp3nametable.js"></script>
		<script src="Tables/fogparametertable.js"></script>
		<script src="Tables/ClassResNameTable.js"></script>
		<script src="Tables/pcjobtable.js"></script>
		<script src="Tables/AccessoryIdTable.js"></script>
		<script src="Tables/AccessoryNameTable.js"></script>
		<script src="Tables/HeadIdTable.js"></script>
		
		<script src="SoundPlayer.js"></script>
		
		<script src="InputEventHandler.js"></script>
		
		<script src="graphics/include/BoundingBox.js"></script>
		
		<script src="FileFormat/rsm.js"></script>
		<script src="FileFormat/gat.js"></script>
		<script src="FileFormat/gnd.js"></script>
		<script src="FileFormat/rsw.js"></script>
		<script src="FileFormat/sprparser.js"></script>
		<script src="FileFormat/actparser.js"></script>
		
		<script src="include/three.58.js"></script>
		<script src="include/ReusableRay.js"></script>
		
		<script src="RagnarokControls.js"></script>
		
		<script src="Deferred.js"></script>
		
		<script src="ResourceLoader.js"></script>
		<script src="MapLoader.js"></script>
		
		<script src="SpriteActor.js"></script>
		
	</head>
	
	<style>
	
	canvas {
		display: block;
	}
	
	html, body {
		width: 100%;
		height: 100%;
		background: #000000;
	}
	
	body {
		background: url("load_kr/loading02.edit.jpg") center center fixed;
		background-size: cover;
	}
	
	* {
		padding: 0;
		margin: 0;
	}
	
	</style>
	
	<body>
	
	<script>

'use strict';

var webGlTest = function() {
	
	if (!window.WebGLRenderingContext) {
		return false; 
	}

	var gl = document.createElement("canvas").getContext("webgl")
		|| document.createElement("canvas").getContext("experimental-webgl");
	
	if(!gl) {
		return false;
	}
	
	return true;
}

window.onload = function() {

	var e0 = window.navigator.userAgent.match("((Chrom(e|(ium)))|(Firefox))/2[0-9]") == null;
	var e1 = !webGlTest();
	
	
	var skip = location.href.match('compatibility-ignore');
	
	if((e0 || e1) && !skip) {
		
		window.document.body.style.background = "#eeeeee";
	
		var msg1 = (e0 && "Incompatible browser") || (e1 && "WebGL not supported");
		var msg2 = (e0 && "<p>This demo requires a recent version of Google Chrome or Mozilla Firefox. Sorry about that!</p><p>Please upgrade your browser and come back.</p>")
			|| (e1 && "<p>Your computer does not seem to support WebGL. Find out more at <a style='text-decoration: none' href='http://get.webgl.org/'>get.webgl.org</a></p>");
	
		window.document.body.innerHTML = "\
		<div style='position: absolute; top: 25%; left: 10%; width: 80%; height: 50%; line-height: 3em;'>\
			<div style='font-family: helvetica, calibri; padding: 10px;'>\
				<span style='font-size: 5em; font-family: helvetica, calibri; color: #666666;'>" + msg1 + "</span><br />\
				<div style='margin-top: 1em; max-width: 80%;'>\
					<span style='font-size: 2em;;'>" + msg2 + "</span>\
				</div>\
				<div style='max-width: 80%;'>\
					<span style='font-size: 1em; font-weight: bold;'>Want to try anyway? <a style='text-decoration: none' href='?compatibility-ignore'>Click here.</a></span>\
				</div>\
			</div>\
		\
		</div>";
		
	} else {
		start();
	}

};

var start = function() {
		
	window.document.body.innerHTML = "\
		<div id='b_loading' style='position: absolute; top: 50%; left: 50%; width: 64px; height: 64px; margin-left: -32px; margin-top: -32px;'>\
			<img src='assets/loading64-2.gif' />\
		</div>";//<script>
	
	var bLoading = document.getElementById("b_loading");
	
	var mapLoader = new MapLoader();
	
	window.mapLoader = mapLoader;
	
	var obj = new SpriteActor(mapLoader);
	
	obj.name = "curiosity";
	
	var start = Date.now();
	
	var mapName = location.href.match(/map=([\w\d_]+.rsw)/i);
	
	
	var eventHandler = new InputEventHandler( window.document );
	
	mapLoader
		.loadMap((mapName !== null && mapName[1]) || "payon.rsw")
		.then(function(d) {
			
			console.log("Info: Loading finished in " + (Date.now() - start) + "ms");
			
			// Hide loading stuff
			document.body.removeChild(bLoading);
			
			// Start rendering
			mapLoader.start();
			
			// Play music
			//SoundPlayer.playBGM(mp3NameTable[mapLoader.getMapName()]);
			
			// Set position
			//obj.SetGatPosition(44, 136);
			obj.SetGatPosition(262, 85);
			
			window.s = obj;
			
			// Bind camera to player
			mapLoader.bindCamera(obj);
			
			// Setup events
			
			eventHandler.attachEventListener("mousemove", mapLoader.mouseMoveEvent );
			eventHandler.attachEventListener("mouseup", mapLoader.mouseUpEvent );
			
		})
		
		.then(lol.bind(this, obj, "sprite/ÀÎ°£Á·/¸öÅë/³²/" + ClassResNameTable[14] + "_³²", SpriteActor.Attachment.BODY))
		.then(lol.bind(this, obj, "sprite/ÀÎ°£Á·/¸Ó¸®Åë/³²/" + HeadIdTable[1][ parseInt(Math.random() * HeadIdTable[1].length ) ] + "_³²", SpriteActor.Attachment.HEAD))
		.then(lol.bind(this, obj, "sprite/shadow", SpriteActor.Attachment.SHADOW))
		//.then(lol.bind(this, obj, "sprite/¾Ç¼¼»ç¸®/³²/³²_Åä³¢¸Ó¸®¶ì", SpriteActor.Attachment.TOP))
		.then(function() {
			
			//settop(AccessoryIdTable.ACCESSORY_SAHT_GAHT);
			setmid(AccessoryIdTable.ACCESSORY_ELF_SUNGLASS);
			//settop(AccessoryIdTable.ACCESSORY_HELM)
			settop(AccessoryIdTable.ACCESSORY_ANGEL_MIXHELM)
			//setmid(AccessoryIdTable.ACCESSORY_FIN_HELM)
			
			setInterval(function() {
			
				//console.log(mapLoader.camera);
			
				obj.Update(mapLoader.camera);
			}, 10);
		
		});
};

function say(message) {
	s.displayMessageLabel(message);
};

function setclass(class_id) {
	lol(window.s, "sprite/ÀÎ°£Á·/¸öÅë/³²/" + ClassResNameTable[ class_id ] + "_³²", SpriteActor.Attachment.BODY);
}

function settop(accessory_id) {
	lol(window.s, "sprite/¾Ç¼¼»ç¸®/³²/³²" + AccessoryNameTable[ accessory_id ], SpriteActor.Attachment.TOP);
}

function setmid(accessory_id) {
	lol(window.s, "sprite/¾Ç¼¼»ç¸®/³²/³²" + AccessoryNameTable[ accessory_id ], SpriteActor.Attachment.MID);
}

function setbottom(accessory_id) {
	lol(window.s, "sprite/¾Ç¼¼»ç¸®/³²/³²" + AccessoryNameTable[ accessory_id ], SpriteActor.Attachment.BOTTOM);
}

function npc(npc_id, x, y) {
	var npc = spawn("sprite/npc/" + npc_id, false, x, y);
	
	npc.type = SpriteActor.Types.NPC;
	npc.name = npc_id;
	
	return npc;
}

function monster(monster_id, x, y) {
	
	var m = spawn("sprite/¸ó½ºÅÍ/" + monster_id, true, x, y);
	
	m.type = SpriteActor.Types.MONSTER;
	m.name = monster_id;
	
	return m;
}

function allplayer() {
	
	var k = 0;
	
	for(var i in ClassResNameTable) {
		setTimeout(player.bind(this, i), k * 350);
		k++;
	};
	
};

function player(class_id) {
	
	var actor = spawn("sprite/ÀÎ°£Á·/¸öÅë/³²/" + ClassResNameTable[ class_id ] + "_³²", true);
	
	lol(actor, "sprite/ÀÎ°£Á·/¸Ó¸®Åë/³²/" + HeadIdTable[1][ parseInt(Math.random() * HeadIdTable[1].length ) ] + "_³²", SpriteActor.Attachment.HEAD);
	
	actor.type = SpriteActor.Types.PLAYER;
	actor.name = "job_" + class_id;
	
	return actor;
	
};

function spawn(path, move, gat_x, gat_y) {

	var task = Deferred();
	var actor = new SpriteActor(mapLoader);
	
	gat_x = gat_x || (s.gatPosition.x + Math.round(5 - Math.random() * 10));
	gat_y = gat_y || (s.gatPosition.y + Math.round(5 - Math.random() * 10));
	
	task.then(lol.bind(this, actor, path, SpriteActor.Attachment.BODY));
	
	task.then(lol.bind(this, actor, "sprite/shadow", SpriteActor.Attachment.SHADOW));
	
	task.finally(function() {
		actor.SetGatPosition(gat_x, gat_y);
		actor.MovementSpeed = 200;
	});
	
	var lines = [
		"lol noobs!",
		"come at me bro",
		"testing....",
		"this is horrible",
		"i'm not botting....",
		"chill man its cool",
		"what?",
		"idk yo",
		"huehuehuehue",
		"brasil #1 !!!!!",
		"^___^",
		"xD that so funny",
		"like wut?",
		"hmmmmmmmmmmmm",
		"this game is stupid",
		"selling gr card 1M PM ME!!",
		"hey guys"
	];
	
	if(move) setInterval((function(obj) {
		return function() {
			
			if(Math.random() < 0.05 && obj.type == SpriteActor.Types.PLAYER) {
				obj.displayMessageLabel(obj.name + ": " + lines[ Math.round( Math.random() * (lines.length - 1) ) ]);
			}
			
			if(Math.random() < 0.5) {			
				obj.MoveToGatPosition(
					obj.gatPosition.x + Math.round(5 - Math.random() * 10),
					obj.gatPosition.y + Math.round(5 - Math.random() * 10)
				);			
			}
			
		}
	})(actor), 1500 + Math.random() * 1000);
	
	setInterval(function() {
		actor.Update(mapLoader.camera);
	}, 10);

	return actor;

};

function lol(obj, n, ttype) {

	console.log("Info: Loading attachment " + n);

	var queue = Deferred();
	
	var name = n;
	
	var sprFileObject = null;
	var actFileObject = null;
	
	// Get SPR object
	queue
		.then(ResourceLoader.getProcessedFileObject.bind(this, ResourceLoader.FileType.SPR, name + ".spr"))
		.then(function(pObj) {
			sprFileObject = pObj;
		});
	
	// Get ACT object
	queue
		.then(ResourceLoader.getProcessedFileObject.bind(this, ResourceLoader.FileType.ACT, name + ".act"))
		.then(function(pObj) {
			actFileObject = pObj;
		});
	
	// Set attachment
	return queue.finally(function() {
		obj.SetAttachment(ttype, sprFileObject, actFileObject);
		obj.addAttachmentToScene(mapLoader.scene, ttype);
	})
	
}

	</script>
	
	</body>
</html>